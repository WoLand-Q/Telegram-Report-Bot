# Telegram Report Bot
## _Automated Plan-Fact Reporting System_

[![Bot Logo](icon.png)](https://github.com/WoLand-Q/botmafia)

[![S](https://img.shields.io/badge/Telegram-Open-blue?style=flat-square&logo=telegram&logoColor=white%20&logoSize=auto&label=Telegram&labelColor=blue&color=green&cacheSeconds=3600)](https://t.me/yarmitt)


Telegram Report Bot – это инструмент для автоматизации формирования и отправки отчётов о плановых и фактических показателях работы заведений. Бот объединяет данные из локальных Excel-файлов и удалённого OLAP API сервиса IIKO, предоставляя как детальные отчёты для отдельных заведений, так и агрегированные отчёты по сетям (например, для городов: Киев, Днепр, Харьков).

- Запрашивайте подробные отчёты для выбранного заведения и даты
- Загружайте Excel-файлы с данными через команду `/upload`
- Получайте тестовые отчёты командой `/test`
- Автоматически получайте ежедневный агрегированный отчёт (настраивается по киевскому часовому поясу)

---

## Функциональность

### Основные возможности
- **Интерактивный запрос отчётов**  
  Пользователь вводит команду `/get_plan_fact`, затем:
  - Вводит дату (формат `YYYY-MM-DD`)
  - Выбирает заведение из списка (основываясь на именах файлов в папке `data_excels`)
  - Получает детальный отчёт с разбивкой по категориям

- **Загрузка Excel-файлов**  
  Команда `/upload` позволяет загрузить файлы с плановыми данными в формате Excel, которые сохраняются в папке `data_excels`.

- **Тестовый отчёт**  
  Команда `/test` генерирует отчёт для первого найденного заведения, чтобы убедиться в корректной работе системы.

- **Автоматическая рассылка агрегированного отчёта**  
  Ежедневно бот собирает данные за предыдущий день, агрегирует их по сетям (например, Киев, Днепр, Харьков) и отправляет итоговый отчёт на список Telegram ID, указанный в файле `auto_report_users.json`.

---

## Конфигурация и Настройки

### Переменные окружения и файлы конфигурации
- **BOT_TOKEN** – Токен вашего Telegram-бота, полученный через BotFather.
- **ADMIN_CHAT_ID** – ID чата или канала для отправки отчётов администраторам.
- **IIKO_HOST, LOGIN, PASSWORD_SHA1** – Параметры для подключения и авторизации к OLAP API сервиса IIKO.
- **PLAN_FACT_FOLDER** – Папка для хранения Excel-файлов с данными.  
  _Примечание: Имена файлов должны соответствовать названиям заведений._

### Параметры отчётов
- **CATEGORIES** – Список категорий, например: `["доставка", "зал", "агрегаторы"]`
- **REPORT_TYPE, GROUP_BY_ROW_FIELDS, AGGREGATE_FIELDS, BUILD_SUMMARY, FILTERS** – Настройки для формирования запроса к OLAP API.

### Настройки автоотчёта
- **NETWORK_GROUPS** – Словарь, где ключ – название сети (например, "Киев"), а значение – список точек (имён файлов, как они указаны) входящих в сеть.
- **AUTO_REPORT_USERS_FILE** – JSON-файл, содержащий массив Telegram ID, на которые будет отправляться ежедневный агрегированный отчёт.

### Часовой пояс
Ежедневное задание на авторассылку настроено на использование киевского времени. Для этого используется библиотека `pytz` с идентификатором `Europe/Kiev`. Пример настройки:
```python 
import pytz
from datetime import time

kiev_tz = pytz.timezone("Europe/Kiev")
app.job_queue.run_daily(
    auto_report_job,
    time=time(hour=0, minute=6, second=0, tzinfo=kiev_tz),
    name="auto_report_job"
) 
```

## Основные Компоненты

## 1. Подключение к API IIKO

iiko_login() / iiko_logout()
- Функции для авторизации и завершения сессии с IIKO API.


build_olap_request_body()
- Формирует тело запроса для получения OLAP отчёта с заданными фильтрами и агрегациями.


fetch_olap_report()
- Отправляет запрос к API и возвращает JSON с данными.


get_report_for_department()
- Запрашивает отчёт для конкретного заведения за заданный период.


## 2. Работа с Excel Данными

parse_plan_fact_excel()
- Читает Excel-файл заведения, извлекает плановые показатели (продажи, заказы, средний чек, количество гостей) по датам и категориям.

combine_plan_fact_with_iiko()
- Объединяет данные из Excel (план) и данные из API IIKO (факт) для расчёта итоговых показателей.

get_detailed_plan_fact()
- Собирает детальный отчёт для конкретного заведения с разбивкой по категориям и общей сводкой.

## 3. Интерактивный Запрос Отчёта

- Команда /get_plan_fact реализована с помощью ConversationHandler и включает следующие шаги:
- get_plan_fact_start(): Запрос даты у пользователя.
- get_date_handler(): Обработка введённой даты и вывод списка заведений.
- choose_department_handler(): Обработка выбора заведения и отправка детального отчёта.
- cancel_handler(): Отмена диалога.

## 4. Автоматическая Рассылка Ежедневного Агрегированного Отчёта

get_aggregated_network_plan_fact()
- Собирает и агрегирует данные по всем точкам, входящим в сети, для заданной даты.

auto_report_job()
- Формирует агрегированный отчёт за предыдущий день и отправляет его на список Telegram ID, указанный в auto_report_users.json.

## 5. Дополнительные Команды

- /start – Выводит приветственное сообщение.
- /upload – Инструкция по загрузке Excel-файла.
- /test – Генерирует тестовый отчёт для проверки работоспособности системы.

## 7. Отправка Сообщений

send_long_message()
- Функция разбивает длинный текст отчёта на части (до 3500 символов) для корректной отправки Markdown-сообщений.


## Установка и Запуск

Зависимости
Python 3.7+
Библиотеки: python-telegram-bot, requests, openpyxl, pytz

Установите зависимости с помощью pip:
```sh
pip install python-telegram-bot requests openpyxl pytz
```

## Подготовка
- Создайте папку data_excels в корневой директории проекта для хранения Excel-файлов.
- Добавьте Excel-файлы с данными. Имена файлов должны соответствовать названиям заведений.
- Создайте файл auto_report_users.json и внесите в него список Telegram ID, например:
 ```sh
[123456789, 987654321]
```

## Настройте переменные: обновите BOT_TOKEN, ADMIN_CHAT_ID, IIKO_HOST, LOGIN, PASSWORD_SHA1 в соответствии с вашими данными.

## Запуск Бота

Запустите скрипт:
 ```sh
python <имя_файла>.py
```

Бот начнёт прослушивание команд в Telegram, а также запустит ежедневный планировщик для авторассылки отчётов.

## Поток Работы и Данные

Пользовательский запрос отчёта:

> Пользователь вводит /get_plan_fact
> Бот запрашивает дату (YYYY-MM-DD) и выводит список заведений.
> После выбора заведения бот объединяет данные из Excel и API IIKO и отправляет детальный отчёт.

## Загрузка данных:

- Команда /upload позволяет пользователю загрузить новый Excel-файл, который сохраняется в data_excels.

## Тестирование:

- Команда /test генерирует отчёт для первого найденного заведения и отправляет его в текущий чат для проверки корректности данных.

## Ежедневный автоотчёт:

- Планировщик (job_queue) запускает функцию auto_report_job каждый день в заданное время (с учётом киевского часового пояса).
- Отчёт агрегируется по заданным сетям (NETWORK_GROUPS) и отправляется на список Telegram ID из auto_report_users.json.
  
## Расширение и Модификация

- Добавление новых категорий/сетей: Измените переменные CATEGORIES и NETWORK_GROUPS в конфигурации.
- Настройка запроса к API: Параметры OLAP-запроса можно изменить в REPORT_TYPE, GROUP_BY_ROW_FIELDS, AGGREGATE_FIELDS, BUILD_SUMMARY и FILTERS.
- Изменение расписания: Параметры времени в app.job_queue.run_daily() можно настроить, не забыв указать корректную временную зону (Europe/Kiev).


## Заключение
> Telegram Report Bot объединяет данные из локальных Excel-файлов и удалённого API IIKO для формирования подробных и агрегированных отчётов. Он поддерживает как интерактивные запросы пользователей, так и автоматическую рассылку ежедневных отчётов, что делает его мощным инструментом для мониторинга и анализа показателей работы заведений.
